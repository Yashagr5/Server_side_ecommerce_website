<html>

<head>
    <!-- Compiled and minified CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <link rel="stylesheet" href="/stylesheets/project.css">
    <!-- Compiled and minified JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <!-- JQUERY -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>

    <!--Import Google Icon Font-->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="/javascripts/project.js"></script>

</head>

<body>
    <!-- <% var db=['Tue', 'Fri']
    var weeks=['Mon', 'Tue' , 'Wed' , 'Thr' , 'Fri' , 'Sat' , 'Sun' ]
     weeks.map((item)=>{
        if(db.includes(item)){%>
                <label>
                    <input type="checkbox" checked="checked" value="<%=item%>"/>
                    <span><%=item%></span>
                </label>
            <%} else {%>
                    <label>
                        <input type="checkbox" checked="checked" value="<%=item%>"/>
                        <span><%=item%></span>
                    </label>
                    <%}})%> -->


                        <% if(status==false) { %>
                            <h2>
                                <%=data%>
                            </h2>
                            <% } else {%>
                                <div class="tableContainer">
                                    <div class="tableBox">
                                        <table class="striped">
                                            <div class="headingBox alignCenter">
                                                <div class="headingText">
                                                    List of Products
                                                </div>
                                            </div>
                                            <tr>
                                                <th>Product Id</th>
                                                <th>Category</th>
                                                <th>Product Name</th>
                                                <th>Description</th>
                                                <th>Price</th>
                                                <th>Rating</th>
                                                <th>Status</th>
                                                <th>Picture</th>
                                                <th>Update</th>
                                            </tr>
                                            <% data.map((item)=>{%>
                                                <tr>
                                                    <td>
                                                        <%= item.productid%>
                                                    </td>
                                                    <td>
                                                        <%= item.categoryname%><br>
                                                            <%= item.subcategoryname%>
                                                    </td>
                                                    <td>
                                                        <%= item.productname%><br>
                                                            <%= item.brandname%>
                                                    </td>
                                                    <td>
                                                        <%= item.description%>
                                                    </td>
                                                    <td>
                                                        <%if(item.offerprice>0){%>
                                                            <div style="color:crimson">
                                                                <s>
                                                                    <%= item.price%><br>
                                                                </s><br>
                                                            </div>
                                                            <div style="color:rgb(11, 242, 165); font-weight: bolder;">
                                                                <strong>
                                                                    <%= item.offerprice%>
                                                                </strong>
                                                            </div>
                                                            <%} else {%>
                                                                <div
                                                                    style="color: rgb(30, 214, 153); font-weight: bolder;">
                                                                    <strong>
                                                                        <%=item.price%>
                                                                            <%}%>
                                                                    </strong>
                                                                </div>
                                                                Stock:<%=item.stock%>
                                                    </td>
                                                    <td>
                                                        <%= item.ratings %>
                                                    </td>
                                                    <td>
                                                        <%= item.status %>
                                                    </td>
                                                    <td>
                                                        <button type="button" class="btnpicture"
                                                            products="<%=JSON.stringify(item)%>">
                                                            <img src="/images/<%=item.picture%>"
                                                                style="border-radius:20px ; width: 60px;">
                                                        </button>
                                                    </td>
                                                    <td>
                                                        <!-- <input type="button" products="<%=JSON.stringify(item)%>" value="Edit"
                                            class="btnedit"> -->
                                                        <button class="btnedit btn waves-effect waves-light"
                                                            type="button" products="<%=JSON.stringify(item)%>">Edit
                                                            <i class="material-icons right">send</i>
                                                        </button>
                                                    </td>
                                                </tr>
                                                <%})%>
                                        </table>
                                        <!-- Dialog Product-->

                                        <!-- Modal Structure -->
                                        <div id="product" class="modal"
                                            style="width: 80%; overflow: hidden; max-height: 600px;">
                                            <div class="modal-content">
                                                <!-- <form action="/product/submitproduct" method="post" enctype="multipart/form-data"> -->
                                                <div class="dContainer alignCenter">
                                                    <div class="dBox">
                                                        <div class="headingBox alignCenter">
                                                            <div class="headingText">Update/Delete Product</div>
                                                        </div>

                                                        <input type="hidden" id="productid">

                                                        <div class="row">
                                                            <div class="input-field col s4">
                                                                <i class="material-icons prefix">next_week</i>
                                                                <select required name="categoryid" id="categoryid">
                                                                    <option value="" disabled selected>Choose your
                                                                        option</option>
                                                                </select>
                                                                <label>Categories</label>
                                                            </div>
                                                            <div class="input-field col s4">
                                                                <i class="material-icons prefix">grid_on</i>
                                                                <select required name="subcategoryid"
                                                                    id="subcategoryid">
                                                                    <option value="" disabled selected>Choose your
                                                                        option</option>
                                                                </select>
                                                                <label>SubCategories</label>
                                                            </div>
                                                            <div class="input-field col s4">
                                                                <i class="material-icons prefix">new_releases</i>
                                                                <select required name="brandid" id="brandid">
                                                                    <option value="" disabled selected>Choose your
                                                                        option</option>
                                                                </select>
                                                                <label>Brands</label>
                                                            </div>
                                                        </div>
                                                        <div class="row">
                                                            <div class="input-field col s6">
                                                                <i class="material-icons prefix">shopping_cart</i>
                                                                <input required id="productname" name="productname"
                                                                    type="text" class="validate">
                                                                <label for="productname">Product Name</label>
                                                            </div>
                                                            <div class="input-field col s6">
                                                                <i class="material-icons prefix">description</i>
                                                                <input required id="description" name="description"
                                                                    type="text" class="validate">
                                                                <label for="description">Description</label>
                                                            </div>
                                                        </div>
                                                        <div class="row">
                                                            <div class="input-field col s4">
                                                                <i class="material-icons prefix">attach_money</i>
                                                                <input required id="price" name="price" type="text"
                                                                    class="validate">
                                                                <label for="price">Price</label>
                                                            </div>
                                                            <div class="input-field col s4">
                                                                <i class="material-icons prefix">money_off</i>
                                                                <input required id="offerprice" name="offerprice"
                                                                    type="text" class="validate">
                                                                <label for="offerprice">Offer Price</label>
                                                            </div>
                                                            <div class="input-field col s4">
                                                                <i class="material-icons prefix">add_shopping_cart</i>
                                                                <input required id="stock" name="stock" type="text"
                                                                    class="validate">
                                                                <label for="stock">Stock</label>
                                                            </div>
                                                        </div>
                                                        <div class="row">
                                                            <div class="input-field col s6">
                                                                <i class="material-icons prefix">star</i>
                                                                <input required id="ratings" name="ratings" type="text"
                                                                    class="validate">
                                                                <label for="ratings">Ratings</label>
                                                            </div>
                                                            <div class="input-field col s6">
                                                                <i class="material-icons prefix">edit_location</i>
                                                                <select required id="status" name="status">
                                                                    <option value="" disabled selected>Choose your
                                                                        option</option>
                                                                    <option value="Continue">Continue</option>
                                                                    <option value="Discontinue">Discontinue</option>
                                                                </select>
                                                                <label>Status</label>
                                                            </div>
                                                        </div>
                                                        <div class="row">
                                                            <div class="col s6 alignCenter">
                                                                <button class="btn waves-effect waves-light"
                                                                    id="updbtn">Edit
                                                                    <i class="material-icons right">edit</i>
                                                                </button>
                                                            </div>
                                                            <div class="col s6 alignCenter">
                                                                <button class="btn waves-effect waves-light"
                                                                    id="delbtn">Delete
                                                                    <i class="material-icons right">delete</i>
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <!-- </form> -->
                                            </div>
                                            <!-- <div class="modal-footer">
                            <a href="#!" class="modal-close waves-effect waves-green btn-flat">Close</a>
                        </div> -->
                                        </div>
                                        <!-- End Dialogue -->

                                        <!-- Picture Dialog -->
                                        <!-- Vertically centered modal -->
                                        <div id="picturedialog" class="modal">
                                            <div class="modal-content">
                                                <div id="tittle" style="font-size: 24px; font-weight: bold;">Edit
                                                    product</div>
                                                <div><img id="ppicture"></div>
                                                <div>
                                                    <strong>Select New Picture you want to Upload</strong>
                                                </div>
                                                <div class="row">
                                                    <div class="col s6">
                                                        <div class="file-field input-field">
                                                            <div class="btn">
                                                                <span>File</span>
                                                                <input required type="file" id="picture">
                                                            </div>
                                                            <div class="file-path-wrapper">
                                                                <input class="file-path validate" type="text">
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col s6">
                                                        <button class="btn waves-effect waves-light" type="button"
                                                            id="uploadpicture">Upload
                                                            <i class="material-icons right">send</i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- End PIcture Dialog -->




                                    </div>
                                </div>
                                <% } %>
</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
<script>
    $(document).ready(function () {
        $('.modal').modal();
        $('.btnedit').click(function () {
            $('#product').modal('open')
            var item = JSON.parse($(this).attr('products'))
            // alert(item.productname)
            $('#categoryid').val(item.categoryid)

            // $.getJSON(`http://localhost:3000/product/fetch_all_subcategories`,{'categoryid':item.categoryid},function(data){
            // // alert(JSON.stringify(data))
            // $('#subcategoryid').empty()
            // $('#subcategoryid').append($('<option>').text('Choose subcategory'));

            // data.subcategory.map((item)=>{
            //     $('#subcategoryid').append($('<option>').text(item.subcategoryname).val(item.subcategoryid));
            // })
            //fill subcategory
            fillSubcategory(item.categoryid, item.subcategoryid);
            // $('#subcategoryid').val(item.subcategoryid)
            // $('#subcategoryid').formSelect();
            // });

            // $('#subcategoryid').val(item.subcategoryid)
            //END subCAtegory

            //    FILL BRAND

            //    $.getJSON(`http://localhost:3000/product/fetch_all_brands`,{'categoryid':item.categoryid},function(data){
            //     // alert(JSON.stringify(data))
            //     $("#brandid").empty()
            //     $("#brandid").append($('<option>').text('Choose Brand'));

            //     data.brand.map((item)=>{
            //         $("#brandid").append($('<option>').text(item.brandname).val(item.brandid));
            //     })
            //     $("#brandid").val(item.brandid);
            //     $("#brandid").formSelect(); 
            // });
            fillBrand(item.categoryid, item.brandid);
            // END BRAND

            $('#productid').val(item.productid)
            $('#productname').val(item.productname)
            $('#description').val(item.description)
            $('#price').val(item.price)
            $('#offerprice').val(item.offerprice)
            $('#stock').val(item.stock)
            $('#ratings').val(item.ratings)
            $('#status').val(item.status)

            $('#categoryid').formSelect();
            // $('#subcategoryid').formSelect();
            // $('#brandid').formSelect();
            $('#status').formSelect();

            M.updateTextFields()

        })
        $('#updbtn').click(function () {
            $.getJSON('/product/editproductdata', { categoryid: $('#categoryid').val(), subcategoryid: $('#subcategoryid').val(), brandid: $('#brandid').val(), productname: $('#productname').val(), description: $('#description').val(), price: $('#price').val(), offerprice: $('#offerprice').val(), stock: $('#stock').val(), ratings: $('#ratings').val(), status: $('#status').val(), productid: $('#productid').val() }, function (data) {
                alert(data.message)
                window.location.reload('/product/display_all_products');
            })
        });

        $('#delbtn').click(function () {
            $.getJSON('/product/deleteproductdata', { productid: $('#productid').val() }, function (data) {

                alert(data.message)
                window.location.reload('/product/dispay_all_products');
            })

        });
        $('.btnpicture').click(function () {
            $('#picturedialog').modal('open')
            var item = JSON.parse($(this).attr('products'))
            $('#productid').val(item.productid);
            $('.tittle').html(`Edit Product ${item.productname}`)
            $('#ppicture').attr('src', `/images/${item.picture}`)
        })

        $('#uploadpicture').click(function () {
            //  alert('hello')
            var formData = new FormData();
            formData.append("productid", $('#productid').val())
            var files = $('#picture')[0].files
            //check file selected or not
            if (files.length > 0) {
                formData.append('picture', files[0]);
                ////////////////ajax///////////////


                $.ajax({
                    url: 'http://localhost:3000/product/updateproductpicture',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,

                    success: function (response) {
                        alert(response.status)
                        window.location.reload('http://localhost:3000/product/display_all_products')
                    }
                })
            } else {
                alert("please select a file.")
            }
            ////////////////////end///////////

        })



    });
</script>

</html>